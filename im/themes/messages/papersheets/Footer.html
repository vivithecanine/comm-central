<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->

<script type="text/javascript;version=1.8">

const bg_gradient = "background: -moz-linear-gradient(top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1) 15px, hsla(#, 100%, 98%, 1) 15px, hsla(#, 100%, 98%, 1));";
const bg_context_gradient = "background: -moz-linear-gradient(top, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.05) 15px, hsla(#, 20%, 98%, 1) 15px, hsla(#, 20%, 98%, 1));";
const bg_color = "background-color: hsl(#, 100%, 98%);";

var body = document.getElementById("ibcontent");


function setColors(target)
{
  var senderColor = target.getAttribute("senderColor");

  if (senderColor) {
    var regexp = /color:\s*hsl\(\s*(\d{1,3})\s*,\s*\d{1,3}\%\s*,\s*\d{1,3}\%\s*\)/;
    var parsed = regexp.exec(senderColor);

    if (parsed) {
      var senderHue = parsed[1];
      if (target.classList.contains("context"))
        target.setAttribute("style", bg_context_gradient.replace("#", senderHue, "g"));
      else
        target.setAttribute("style", bg_gradient.replace("#", senderHue, "g"));
    }
  }

  if (body.scrollHeight <= screen.height) {
    if (senderHue) {
      body.setAttribute("style", bg_color.replace("#", senderHue));
    }
    else if (target.classList.contains("outgoing")) {
      body.className = "outgoing-color";
      body.removeAttribute("style");
    }
    else if (target.classList.contains("incoming")) {
      body.className = "incoming-color";
      body.removeAttribute("style");
    }
    else if (target.classList.contains("event")) {
      body.className = "event-color";
      body.removeAttribute("style");
    }
  }
}


function groupEvents(parent)
{
  var list = parent.getElementsByTagName("p");
  if (list.length < 3)
    return;

  if (list[1].hasAttribute("style")) {
    var prevStyle = list[1].style.display;

    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = prevStyle;
  }
  else {
    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = "none";

    var div = document.createElement("div");
    div.setAttribute("onclick", "toggle_groupEvents(event)");
    div.setAttribute("class", "button hide");
    parent.insertBefore(div, list[0]);

    list[0].lastChild.className += " first-event";
  }
}


function toggle_groupEvents(aEvent)
{
  var button = aEvent.target;
  var list = button.parentNode.getElementsByTagName("p");

  if (button.className == "button hide") {
    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = "block";

    button.className = "button show";

    var oldClass = list[0].lastChild.className;
    list[0].lastChild.className = oldClass.substr(0, oldClass.length - 12);
  }
  else {
    for (var i = 1; i < (list.length - 1); i++)
      list[i].style.display = "none";

    button.className = "button hide";

    list[0].lastChild.className += " first-event";
  }
}


function checkNewText(target)
{
  if (target.tagName == "DIV")
    setColors(target);
  else if (target.tagName == "P" && target.className == "event")
    groupEvents(target.parentNode);
}


MutationObserver(function(aMutations) {
  for (let mutation of aMutations)
    for (let node of mutation.addedNodes)
      if (node instanceof HTMLElement)
        checkNewText(node);
}).observe(document.getElementById("ibcontent"),
           {childList: true, subtree: true});
</script>
